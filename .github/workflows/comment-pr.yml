name: Comment Pull Request

on:
  workflow_run:
    workflows: ["Check Pull Request contents"]
    types:
      - completed

jobs:
  comment:
    name: Comment pull request
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Find PR number
        id: find_pr
        uses: actions/github-script@v8
        with:
          script: |
            const headRepoFull = context.payload.workflow_run.head_repository.full_name;
            const [headOwner] = headRepoFull.split("/");
            const branch = context.payload.workflow_run.head_branch;

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              head: `${headOwner}:${branch}`
            });

            if (prs.data.length === 0) {
              core.setFailed(`No PR found for ${headOwner}:${branch}`);
              return;
            }

            core.setOutput("pr_number", prs.data[0].number);

      - name: Get changed files
        id: files
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              }
            );

            const filenames = files.map(f => f.filename);

            // Check if all files are inside metadata/
            const allInMetadata = filenames.every(f => f.startsWith("metadata/"));

            core.setOutput("all_in_metadata", allInMetadata);
            core.setOutput("changed_files", filenames.join(","));

      - name: Stop if files outside metadata/
        if: steps.files.outputs.all_in_metadata == 'false'
        run: |
          echo "Some files are outside metadata/. Skipping workflow."
          exit 0

      - name: Ensure PR workflow succeeded
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          conclusion=$(gh run view "${{ github.event.workflow_run.id }}" \
            -R "${{ github.repository }}" --json conclusion --jq .conclusion)
      
          if [ "$conclusion" != "success" ]; then
            echo "PR workflow did not succeed (conclusion=$conclusion)"
            exit 1
          fi

      - name: Download test results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download "${{ github.event.workflow_run.id }}" \
            --dir ./test-results \
            -R "${{ github.repository }}"

      - name: Read results
        id: read
        run: |
          {
            echo "RESULT<<EOF"
            cat test-results/cert_check-results/cert_check_results.txt
            cat test-results/qa-results/qa_results.txt
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Post PR comment
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const results = process.env.RESULT;

            const extra = [
              "<br>",
              "Please check the results above and <strong>fix all entries with severity ❌</strong>.",
              "Entries with severity ⚠️ should also be fixed, though those can be acceptable on a case-by-case basis.",
              "",
              "To submit your fixes, either commit them to this pull request or open a new one.",
              "",
              "If there are no issues, your PR will be merged by an operator without further actions from your side."
            ].join("\n");

            const body = `${results}\n\n${extra}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(prNumber),
              body
            });
